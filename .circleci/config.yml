version: 2.1
orbs:
  gcp-gke: circleci/gcp-gke@0.1.0
  helm: circleci/helm@1.0

# Define the jobs we want to run for this project
jobs:
  test:
    docker:
      - image: cimg/node:16.13.0
    steps:
      - checkout
      - run: |
          cd cuquejo.org
          yarn install
          yarn test --watchAll=false

  build-and-push:
    machine:
      image: ubuntu-2004:202107-02
    environment:
      DOCKER_BUILDKIT: 1
      REGISTRY_URL: us-central1-docker.pkg.dev
      TAG: 1.0.0
    steps:
      - checkout
      - run: ./.circleci/setup_gcloud.sh
      - run: gcloud auth configure-docker --quiet $REGISTRY_URL
      - run: make build-ci
      - run: make push-ci

  deploy:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run: ./.circleci/setup_gcloud.sh
      - run: curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 && chmod 700 get_helm.sh && ./get_helm.sh
      - run: helm init --client-only --kubeconfig=$HOME/.kube/kubeconfig
      - run: helm upgrade --install --namespace cuquejo --set image.url=${REGISTRY_URL}/${GOOGLE_PROJECT_ID}/cuquejo/${CIRCLE_PROJECT_REPONAME}:${TAG} cuquejo-org .

# Orchestrate our job run sequence
workflows:
  build_and_test:
    jobs:
      - test
      - build-and-push:
          requires:
            - test
      - deploy:
          requires:
            - build-and-push